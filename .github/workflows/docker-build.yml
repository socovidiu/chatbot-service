name: Docker - Build Chatbot Service Image

on:
  push:
    branches: [ main ]
    paths:
      - "src/**"
      - "pyproject.toml"
      - "uv.lock"
      - "Dockerfile"
      - ".github/workflows/docker-build.yml"

concurrency:
  group: chatbot-docker-build-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write   

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  REPOSITORY: "llm-service"        
  IMAGE_NAME: "llm-service"        

jobs:
  docker-build:
    runs-on: ubuntu-latest

    env:
      # Dummy envs if your Docker build expects them at build time
      OPENAI_API_KEY: "build-time-dummy-key"
      LLM_API_KEY: "build-time-dummy-llm-key"
      LANGCHAIN_PROVIDER: "ollama"
      OLLAMA_BASE_URL: "http://localhost:11434"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Quick sanity check that deps resolve
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Sync dependencies (no-dev)
        run: uv sync

      # Authenticate to GCP via Workload Identity Federation
      - name: Auth to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_ID_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      # Configure Docker for Artifact Registry
      - name: Configure Docker auth for Artifact Registry
        run: |
          gcloud auth configure-docker "${REGION}-docker.pkg.dev" --quiet

      # Build image with full Artifact Registry URI
      - name: Build Docker image
        run: |
          IMAGE_URI_SHA="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${IMAGE_NAME}:${GITHUB_SHA}"
          IMAGE_URI_LATEST="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${IMAGE_NAME}:latest"

          echo "IMAGE_URI_SHA=${IMAGE_URI_SHA}" >> $GITHUB_ENV
          echo "IMAGE_URI_LATEST=${IMAGE_URI_LATEST}" >> $GITHUB_ENV

          docker build -t "${IMAGE_URI_SHA}" .
          docker tag "${IMAGE_URI_SHA}" "${IMAGE_URI_LATEST}"
          echo "Built images:"
          echo "  ${IMAGE_URI_SHA}"
          echo "  ${IMAGE_URI_LATEST}"

      - name: Push Docker image
        run: |
          docker push "${IMAGE_URI_SHA}"
          docker push "${IMAGE_URI_LATEST}"
          echo "Pushed images:"
          echo "  ${IMAGE_URI_SHA}"
          echo "  ${IMAGE_URI_LATEST}"

      # Tell infra repo to deploy this SHA
      - name: Trigger deploy in infra repo
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.INFRA_REPO_TOKEN }}
          repository: socovidiu/resume-builder-k8s   
          event-type: deploy-llm-service
          client-payload: |
            { "image_tag": "${GITHUB_SHA}" }
